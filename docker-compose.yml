version: '2'
services:
    nginx:
      image: nginx:alpine
      ports:
        - "80:80"
        - "443:443"
      restart: unless-stopped
      volumes:
        - ./code/:/var/www/html/:rw
        - ./conf/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./conf/nginx/conf.d:/etc/nginx/conf.d/:ro
        - ./conf/nginx/cert/:/etc/nginx/cert/:rw
        - ./log/nginx/:/var/log/nginx/:rw
      networks:
        - frontend
        - backend
      links:
          - php-fpm1:fpm1
          - php-fpm2:fpm2
    php-fpm1:
        image: "${DOCKER_USER}/php-fpm1:v1"
        build:
            context: .
            dockerfile: Dockerfile.php
        expose:
            - "9000"
        restart: unless-stopped
        volumes:
            - ./code/:/var/www/html/:rw
            - ./conf/php/php.ini:/usr/local/etc/php/php.ini:ro
            - ./conf/php/php-fpm.d/site.conf:/usr/local/etc/php-fpm.d/site.conf:rw
            - ./log/php-fpm/:/var/log/php-fpm/:rw
        networks:
            - frontend
            - backend
    php-fpm2:
        image: "${DOCKER_USER}/php-fpm2:v1"
        build:
            context: .
            dockerfile: Dockerfile.php
        expose:
            - "9000"
        restart: unless-stopped
        tty: true
        volumes:
            - ./code/:/var/www/html/:rw
            - ./conf/php/php.ini:/usr/local/etc/php/php.ini:ro
            - ./conf/php/php-fpm.d/site.conf:/usr/local/etc/php-fpm.d/site.conf:rw
            - ./log/php-fpm/:/var/log/php-fpm/:rw
        networks:
            - frontend
            - backend
volumes:
    mysql-data:

networks:
    frontend:
    backend: